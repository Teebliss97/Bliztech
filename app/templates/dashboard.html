{% extends "base.html" %}

{% block content %}
  <div class="page-head">
    <h1 class="page-title">Welcome back ğŸ‘‹</h1>
    <p class="page-subtitle">
      Youâ€™re making progress â€” keep going.
    </p>
  </div>

  <!-- ===================== PROFILE / ACCOUNT CARD ===================== -->
  <div class="course-progress" style="margin-top:16px;">
    <div class="course-progress-top">
      <span class="badge">Your account</span>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;">
        {% if current_user.is_admin %}
          <span class="badge">ğŸ›¡ï¸ Admin</span>
        {% else %}
          <span class="badge">ğŸ‘¤ Learner</span>
        {% endif %}
      </div>
    </div>

    <p class="page-subtitle" style="margin:8px 0 0;">
      Signed in as <strong>{{ current_user.email }}</strong>
    </p>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <span class="badge">ğŸ§¾ Total attempts: {{ stats.attempts_total }}</span>

      {% if stats.last_activity %}
        <span class="badge">
          ğŸ•’ Last activity: {{ stats.last_activity.strftime('%d %b %Y, %H:%M') }}
        </span>
      {% else %}
        <span class="badge">ğŸ•’ Last activity: Not yet</span>
      {% endif %}
    </div>
  </div>

  <!-- ===================== REFERRAL CARD (NEW) ===================== -->
  <div class="course-progress" style="margin-top:16px;">
    <div class="course-progress-top">
      <span class="badge">Your referral link</span>
      <span class="course-progress-text">Invite people and earn credit</span>
    </div>

    {% if current_user.referral_code %}
      <p class="page-subtitle" style="margin:10px 0 0;">
        Share this link (it automatically tracks referrals):
      </p>

      <!-- display link -->
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input
          id="refLink"
          type="text"
          readonly
          value="{{ url_for('main.home', ref=current_user.referral_code, _external=True) }}"
          style="flex:1; min-width:260px;"
        />

        <button class="btn btn-outline" type="button" id="copyRefBtn">
          Copy link
        </button>

        <a
          class="btn btn-outline"
          target="_blank"
          rel="noopener"
          href="https://wa.me/?text={{ (url_for('main.home', ref=current_user.referral_code, _external=True) ~ ' â€” Learn cybersecurity for free on BlizTech')|urlencode }}"
        >
          Share on WhatsApp
        </a>
      </div>

      <p class="muted" style="margin:10px 0 0; font-size:13px; line-height:1.6;">
        Tip: Anyone who signs up after clicking your link will be linked to you as their referrer.
      </p>

    {% else %}
      <p class="page-subtitle" style="margin:10px 0 0;">
        Your referral code is not ready yet. Refresh the page or log out and log in again.
      </p>
    {% endif %}
  </div>

  <!-- ===================== PRIMARY PROGRESS CARD ===================== -->
  <div class="course-progress" style="margin-top:16px;">
    <div class="course-progress-top">
      <span class="badge">Your progress</span>
      <span class="course-progress-text">
        <strong>{{ stats.completed }}</strong> / {{ stats.total }} completed â€¢ {{ stats.percent }}%
      </span>
    </div>

    <div class="course-bar">
      <div class="course-bar-fill" style="width: {{ stats.percent }}%;"></div>
    </div>

    <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
      {% if stats.course_done %}
        <p class="muted" style="margin:0;">ğŸ‰ Youâ€™ve completed the course!</p>
        <a class="btn" href="{{ url_for('cert.certificate_home') }}">ğŸ“ Download Certificate</a>
        <a class="btn btn-outline" href="{{ url_for('topics.list_topics') }}">Review Topics</a>
      {% else %}
        {% if resume %}
          <a class="btn" href="{{ url_for('topics.topic_detail', slug=resume.slug) }}">
            â–¶ Continue where you stopped
          </a>
          <a class="btn btn-outline" href="{{ url_for('quizzes.quiz', slug=resume.slug) }}">
            Take Quiz
          </a>
        {% elif next_topic %}
          <a class="btn" href="{{ url_for('topics.topic_detail', slug=next_topic.slug) }}">
            â–¶ Continue learning
          </a>
          <a class="btn btn-outline" href="{{ url_for('topics.list_topics') }}">
            View full course â†’
          </a>
        {% else %}
          <a class="btn" href="{{ url_for('topics.list_topics') }}">Start the course</a>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- ===================== WHAT'S NEXT ===================== -->
  {% if not stats.course_done %}
    <div style="margin-top:26px;">
      <h2 class="section-title">Whatâ€™s next</h2>
      <p class="page-subtitle">
        Focus on your next step â€” you donâ€™t need to think about everything.
      </p>

      <div class="topics-grid">
        {% for r in rows[:3] %}
          <div class="topic-card {% if not r.unlocked %}is-locked{% endif %} {% if r.passed %}is-completed{% endif %}">
            <div class="topic-top">
              <div class="topic-title-wrap">
                <div class="topic-title">{{ r.title }}</div>

                <div class="topic-badges">
                  {% if r.passed %}
                    <span class="tpill tpill-green">âœ… Completed</span>
                  {% elif r.unlocked %}
                    <span class="tpill tpill-blue">ğŸ”“ Ready</span>
                  {% else %}
                    <span class="tpill tpill-gray">ğŸ”’ Locked</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="topic-desc">
              Attempts: <strong>{{ r.attempts }}</strong>
            </div>

            <div class="topic-actions">
              {% if r.unlocked %}
                <a class="btn" href="{{ url_for('topics.topic_detail', slug=r.slug) }}">Read</a>
                <a class="btn btn-outline" href="{{ url_for('quizzes.quiz', slug=r.slug) }}">Take Quiz</a>
              {% else %}
                <button class="btn btn-disabled" disabled>Locked</button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <div style="margin-top:12px;">
        <a class="btn btn-outline" href="{{ url_for('topics.list_topics') }}">
          View full course â†’
        </a>
      </div>
    </div>
  {% endif %}

  <!-- ===================== COMPLETED TOPICS ===================== -->
  {% if stats.completed > 0 %}
    <div style="margin-top:30px;">
      <h2 class="section-title">Completed topics</h2>
      <p class="page-subtitle">Quick review links to reinforce what youâ€™ve learned.</p>

      <div class="topics-grid">
        {% for r in rows if r.passed %}
          <div class="topic-card is-completed">
            <div class="topic-top">
              <div class="topic-title-wrap">
                <div class="topic-title">{{ r.title }}</div>
                <div class="topic-badges">
                  <span class="tpill tpill-green">âœ… Completed</span>
                  <span class="tpill tpill-dark">Attempts: {{ r.attempts }}</span>
                </div>
              </div>
            </div>

            <div class="topic-actions" style="margin-top:10px;">
              <a class="btn btn-outline" href="{{ url_for('topics.topic_detail', slug=r.slug) }}">Review lesson</a>
              <a class="btn btn-outline" href="{{ url_for('quizzes.quiz', slug=r.slug) }}">Retake quiz</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- ===================== RESET (LOW PRIORITY) ===================== -->
  <div style="margin-top:32px;">
    <details>
      <summary class="muted" style="cursor:pointer;">Reset course progress</summary>
      <form method="POST" action="{{ url_for('main.reset_progress') }}" class="form" style="max-width:420px; margin-top:10px;">
        <p class="page-subtitle">
          Type <strong>RESET</strong> to clear your progress.
        </p>
        <input name="confirm" placeholder="Type RESET to confirm" required>
        <button class="btn btn-outline" type="submit" style="margin-top:10px;">
          Reset progress
        </button>
      </form>
    </details>
  </div>

  <!-- ===================== Copy referral JS (NEW) ===================== -->
  <script>
    (function () {
      const input = document.getElementById("refLink");
      const btn = document.getElementById("copyRefBtn");
      if (!input || !btn) return;

      btn.addEventListener("click", async function () {
        const text = input.value || "";
        try {
          await navigator.clipboard.writeText(text);
          btn.textContent = "Copied âœ…";
          setTimeout(() => (btn.textContent = "Copy link"), 1400);
        } catch (e) {
          // fallback
          input.focus();
          input.select();
          document.execCommand("copy");
          btn.textContent = "Copied âœ…";
          setTimeout(() => (btn.textContent = "Copy link"), 1400);
        }
      });
    })();
  </script>
{% endblock %}
