{% extends "base.html" %}
{% block title %}Admin • Referrals{% endblock %}

{% block content %}
  <h2>Referrals</h2>

  <p class="muted" style="margin-top:-6px;">
    Showing last <strong>{{ days }}</strong> day{{ "s" if days != 1 else "" }} •
    Total referrals in this period: <strong>{{ total_referrals_in_window }}</strong>
  </p>

  <form method="get" class="admin-filters">
    <input
      type="text"
      name="q"
      value="{{ q }}"
      placeholder="Search referrer email or referral code..."
      style="min-width:280px;"
    />

    <input
      type="number"
      name="days"
      value="{{ days }}"
      min="1"
      max="3650"
      style="width:120px;"
      title="Lookback days"
    />

    <button class="btn btn-outline" type="submit">Filter</button>
    <a class="btn btn-outline" href="{{ url_for('admin.referrals') }}">Reset</a>
  </form>

  <h3 style="margin-top:18px;">Top referrers</h3>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Referrer (email)</th>
          <th>Referral code</th>
          <th>Total referred</th>
          <th>Last referral</th>
          <th>Share link</th>
        </tr>
      </thead>
      <tbody>
        {% for r in top_referrers %}
          <tr>
            <td>{{ r.email }}</td>
            <td><code>{{ r.referral_code or "-" }}</code></td>
            <td><strong>{{ r.referrals_count }}</strong></td>
            <td>
              {% if r.last_referral_at %}
                {{ r.last_referral_at.strftime("%Y-%m-%d %H:%M") }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if r.referral_code %}
                <code>/?ref={{ r.referral_code }}</code>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" class="muted">No referrers found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h3 style="margin-top:22px;">Latest referrals</h3>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>When</th>
          <th>Referrer</th>
          <th>Referrer code</th>
          <th>Code used</th>
          <th>Referred user ID</th>
          <th>Status</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {% for row in latest %}
          {% set ref = row[0] %}
          <tr>
            <td>
              {% if ref.created_at %}
                {{ ref.created_at.strftime("%Y-%m-%d %H:%M") }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ row.referrer_email }}</td>
            <td><code>{{ row.referrer_code or "-" }}</code></td>
            <td><code>{{ ref.referral_code_used or "-" }}</code></td>
            <td>{{ ref.referred_user_id }}</td>
            <td>
              {% if ref.status == "signup" %}
                <span class="badge badge-good">signup</span>
              {% elif ref.status == "completion" %}
                <span class="badge badge-blue">completion</span>
              {% elif ref.status == "certificate" %}
                <span class="badge badge-blue">certificate</span>
              {% else %}
                <span class="badge">{{ ref.status }}</span>
              {% endif %}
            </td>
            <td><span class="badge">{{ ref.source }}</span></td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7" class="muted">No referrals found for this period.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
