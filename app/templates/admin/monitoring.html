{% extends "base.html" %}
{% block title %}Monitoring{% endblock %}

{% block content %}
<div class="container" style="max-width: 1150px; margin: 20px auto;">

  <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">Monitoring</h2>
      <div style="opacity:0.85; margin-top:6px;">
        Security signals & recent events (last 24h counters + latest 200 events).
      </div>
    </div>
    <div style="opacity:0.8; font-size: 12px; margin-top:6px;">
      UTC now: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}
    </div>
  </div>

  <div class="stats" style="margin-top:14px;">
    <div class="stat-card">
      <div class="stat-num">{{ counts.rate_limited_24h }}</div>
      <div class="stat-label">429 rate-limited (24h)</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">{{ counts.auth_failed_24h }}</div>
      <div class="stat-label">Login failures (24h)</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">{{ counts.auth_locked_24h }}</div>
      <div class="stat-label">Lockouts (24h)</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">{{ counts.http_error_24h }}</div>
      <div class="stat-label">HTTP errors 4xx/5xx (24h)</div>
    </div>
    <div class="stat-card">
      <div class="stat-num">{{ counts.slow_request_24h }}</div>
      <div class="stat-label">Slow requests (24h)</div>
    </div>
  </div>

  <div style="margin-top:18px;">
    <h3 style="margin:0 0 10px;">Currently Locked (live)</h3>
    <div style="border:1px solid rgba(255,255,255,0.12); border-radius:14px; overflow:hidden;">
      <div style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.06);">
              <th style="text-align:left; padding:12px;">Email</th>
              <th style="text-align:left; padding:12px;">IP</th>
              <th style="text-align:left; padding:12px;">Attempts</th>
              <th style="text-align:left; padding:12px;">Locked Until (UTC)</th>
              <th style="text-align:left; padding:12px;">Last Attempt (UTC)</th>
            </tr>
          </thead>
          <tbody>
          {% if not locked_now %}
            <tr><td colspan="5" style="padding:12px; opacity:0.85;">No active lockouts ðŸŽ‰</td></tr>
          {% else %}
            {% for row in locked_now %}
            <tr style="border-top: 1px solid rgba(255,255,255,0.10);">
              <td style="padding:12px;">{{ row.email }}</td>
              <td style="padding:12px;">{{ row.ip }}</td>
              <td style="padding:12px;">{{ row.attempts }}</td>
              <td style="padding:12px;">{{ row.locked_until.strftime('%Y-%m-%d %H:%M:%S') if row.locked_until else '' }}</td>
              <td style="padding:12px;">{{ row.last_attempt_at.strftime('%Y-%m-%d %H:%M:%S') if row.last_attempt_at else '' }}</td>
            </tr>
            {% endfor %}
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="margin-top:18px;">
    <h3 style="margin:0 0 10px;">Latest Security Events</h3>
    <div style="border:1px solid rgba(255,255,255,0.12); border-radius:14px; overflow:hidden;">
      <div style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.06);">
              <th style="text-align:left; padding:12px;">Time (UTC)</th>
              <th style="text-align:left; padding:12px;">Event</th>
              <th style="text-align:left; padding:12px;">Email</th>
              <th style="text-align:left; padding:12px;">IP</th>
              <th style="text-align:left; padding:12px;">Endpoint</th>
              <th style="text-align:left; padding:12px;">Status</th>
              <th style="text-align:left; padding:12px;">Detail</th>
            </tr>
          </thead>
          <tbody>
          {% if not events %}
            <tr><td colspan="7" style="padding:12px; opacity:0.85;">No events yet.</td></tr>
          {% else %}
            {% for e in events %}
            <tr style="border-top: 1px solid rgba(255,255,255,0.10);">
              <td style="padding:12px; white-space:nowrap;">
                {{ e.created_at.strftime('%Y-%m-%d %H:%M:%S') if e.created_at else '' }}
              </td>
              <td style="padding:12px; font-weight:600;">{{ e.event }}</td>
              <td style="padding:12px;">{{ e.email_masked or '' }}</td>
              <td style="padding:12px;">{{ e.ip or '' }}</td>
              <td style="padding:12px;">{{ e.endpoint or '' }}</td>
              <td style="padding:12px;">{{ e.status if e.status is not none else '' }}</td>
              <td style="padding:12px; max-width: 420px; word-break: break-word; opacity:0.9;">
                {{ e.detail or '' }}
              </td>
            </tr>
            {% endfor %}
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:10px; opacity:0.75; font-size:12px;">Showing latest 200 events.</div>
  </div>

</div>
{% endblock %}
